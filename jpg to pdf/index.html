<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JPG to PDF Converter â€“ Free Online Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#da3f0b',
                            '50': '#fef3f2',
                            '100': '#fee4e2',
                            '200': '#fecdca',
                            '300': '#fda49b',
                            '400': '#f86a59',
                            '500': '#ef4444',
                            '600': '#da3f0b',
                            '700': '#b91c1c',
                            '800': '#991b1b',
                            '900': '#7f1d1d',
                            '950': '#450a0a'
                        }
                    },
                    keyframes: {
                       'fade-in': {
                           'from': { opacity: 0, transform: 'scale(0.95)' },
                           'to': { opacity: 1, transform: 'scale(1)' },
                       },
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-out forwards',
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .group:hover .group-hover-visible { visibility: visible; opacity: 1; }

        /* Toggle switch style */
        #combine-toggle:checked ~ .dot {
            transform: translateX(1.25rem);
        }
        #combine-toggle:checked ~ .block {
            background-color: #da3f0b; /* primary color */
        }
    </style>
</head>
<body class="bg-slate-50">

    <div class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8 font-sans">
        <div class="w-full max-w-6xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-slate-800">JPG to PDF Converter</h1>
                <p class="mt-2 text-slate-500">A powerful tool to combine, edit, and convert your images into a single PDF.</p>
            </header>

            <main id="app-container" class="bg-white rounded-xl shadow-lg p-6 min-h-[500px] w-full">
                <!-- Dropzone View -->
                <div id="dropzone-view">
                    <div id="dropzone" class="relative flex flex-col items-center justify-center w-full p-12 border-2 border-dashed rounded-xl transition-all duration-300 cursor-pointer border-slate-300 bg-slate-50 hover:border-primary/70 hover:bg-primary/5 min-h-[400px]">
                        <input id="file-input" type="file" accept="image/jpeg,image/jpg" class="hidden" multiple />
                        <div class="text-center">
                            <svg class="mx-auto h-16 w-16 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            <p class="mt-4 text-2xl font-semibold text-slate-700">Drop your JPG files here</p>
                            <p class="mt-2 text-slate-500">or <span class="font-bold text-primary">click to browse</span></p>
                        </div>
                    </div>
                </div>

                <!-- Editor View -->
                <div id="editor-view" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left/Main Column: File Grid & Actions -->
                        <div class="lg:col-span-2">
                            <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-slate-700">Selected Images (<span id="file-count">0</span>)</h3>
                                <div class="flex gap-2">
                                    <button id="add-more-button" class="px-4 py-2 text-sm bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 focus:outline-none focus:ring-4 focus:ring-slate-300/50 transition-all duration-200">Add More</button>
                                    <button id="clear-all-button" class="px-4 py-2 text-sm bg-transparent text-slate-700 font-semibold rounded-lg hover:bg-slate-100 border border-slate-300 focus:outline-none focus:ring-4 focus:ring-slate-300/50 transition-all duration-200">Clear All</button>
                                </div>
                            </div>
                            <div id="file-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[520px] overflow-y-auto p-2 bg-slate-100/50 rounded-lg custom-scrollbar border">
                                <!-- Grid items will be injected here -->
                            </div>
                        </div>

                        <!-- Right/Sidebar Column: PDF Options -->
                        <div class="lg:col-span-1">
                            <div class="bg-slate-50 p-4 rounded-lg border sticky top-6">
                                <h3 class="text-lg font-semibold text-slate-800 border-b pb-2 mb-4">PDF Options</h3>
                                <div class="space-y-4">
                                    <!-- Page Size -->
                                    <div>
                                        <label for="page-size" class="block text-sm font-medium text-slate-700 mb-1">Page Size</label>
                                        <select id="page-size" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                                            <option value="a4" selected>A4</option>
                                            <option value="letter">Letter</option>
                                            <option value="legal">Legal</option>
                                        </select>
                                    </div>
                                    <!-- Orientation -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Orientation</label>
                                        <div class="flex gap-2">
                                            <button data-orientation="p" class="orientation-btn w-full p-2 border rounded-md transition-colors bg-primary/10 border-primary text-primary">Portrait</button>
                                            <button data-orientation="l" class="orientation-btn w-full p-2 border rounded-md transition-colors border-slate-300 text-slate-600 hover:bg-slate-100">Landscape</button>
                                        </div>
                                    </div>
                                    <!-- Quality -->
                                    <div>
                                        <label for="quality-slider" class="block text-sm font-medium text-slate-700 mb-1">Image Quality (<span id="quality-value">92</span>%)</label>
                                        <input id="quality-slider" type="range" min="10" max="100" value="92" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-primary">
                                    </div>
                                </div>
                                <!-- Combine Toggle -->
                                <div class="flex items-center justify-between pt-4 mt-4 border-t">
                                    <span class="text-sm font-medium text-slate-700">Combine into single PDF</span>
                                    <label for="combine-toggle" class="flex items-center cursor-pointer">
                                        <div class="relative">
                                            <input type="checkbox" id="combine-toggle" class="sr-only" checked>
                                            <div class="block bg-slate-300 w-10 h-6 rounded-full"></div>
                                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div>
                                        </div>
                                    </label>
                                </div>
                                <button id="convert-button" class="w-full mt-6 flex items-center justify-center gap-3 px-6 py-3 bg-primary text-white font-bold text-lg rounded-lg shadow-md hover:bg-primary-700 active:bg-primary-800 focus:outline-none focus:ring-4 focus:ring-primary/30 transition-all duration-300 disabled:bg-slate-400 disabled:cursor-not-allowed">
                                    Convert to PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Processing View -->
                <div id="processing-view" class="hidden flex-col items-center justify-center text-center p-8 min-h-[400px]">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Creating your PDF...</h2>
                    <div class="w-full max-w-md">
                         <div role="status" class="flex flex-col items-center justify-center">
                            <svg aria-hidden="true" class="w-10 h-10 text-slate-300 animate-spin fill-primary" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 mt-6">
                            <div id="progress-bar" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="processing-message" class="mt-2 text-sm text-slate-500">Initializing...</p>
                    </div>
                </div>

                <!-- Result View -->
                <div id="result-view" class="hidden flex-col items-center justify-center min-h-[400px]">
                    <!-- This will be populated by templates -->
                </div>

                <!-- Error Message -->
                <div id="error-view" class="hidden mt-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-r-lg">
                    <p class="font-bold">An Error Occurred</p>
                    <p id="error-message"></p>
                </div>
            </main>

            <footer class="text-center mt-8">
                <div class="flex items-center justify-center gap-2 text-slate-500 text-sm">
                    <svg class="w-5 h-5 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.016h-.008v-.016z" /></svg>
                    <p>Your files are processed locally in your browser. No data is sent to any servers.</p>
                </div>
            </footer>
        </div>
    </div>

    <template id="file-grid-item-template">
        <div class="animate-fade-in group relative aspect-[4/5] bg-slate-200 rounded-lg flex flex-col overflow-hidden border-2 border-transparent data-[error='true']:border-red-500">
            <div class="relative flex-grow h-0 bg-white">
                <img class="absolute top-0 left-0 w-full h-full object-contain transition-transform duration-300" src="" alt="preview">
            </div>
            <div class="p-2 bg-white border-t border-slate-200">
                <p class="text-xs font-bold text-slate-800 truncate" title="filename"></p>
                <div class="flex justify-between items-center mt-1 text-xs text-slate-500">
                    <div class="flex gap-1.5">
                        <button class="rotate-l-btn p-0.5 rounded-full hover:bg-slate-200" title="Rotate Left 90Â°"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 15l-6 6m0 0l-6-6m6 6V9a6 6 0 0112 0v3" /></svg></button>
                        <button class="rotate-r-btn p-0.5 rounded-full hover:bg-slate-200" title="Rotate Right 90Â°"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15l6 6m0 0l6-6m-6 6V9a6 6 0 00-12 0v3" /></svg></button>
                        <button class="flip-h-btn p-0.5 rounded-full hover:bg-slate-200" title="Flip Horizontal"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" transform="rotate(90 12 12)"/></svg></button>
                        <button class="flip-v-btn p-0.5 rounded-full hover:bg-slate-200" title="Flip Vertical"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg></button>
                    </div>
                    <button class="remove-btn p-0.5 rounded-full text-slate-400 hover:bg-red-100 hover:text-red-600" title="Remove">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
            <div class="status-indicator absolute inset-0 hidden items-center justify-center bg-white/70 backdrop-blur-sm"></div>
        </div>
    </template>

    <template id="single-pdf-result-template">
        <div class="text-center p-8 bg-green-50 rounded-2xl border-2 border-dashed border-green-300 min-h-[400px] flex flex-col justify-center items-center w-full">
            <h2 class="text-2xl font-bold text-green-800">Conversion Successful!</h2>
            <p class="mt-4 text-slate-600">Your PDF document is ready to be downloaded.</p>
            <div class="mt-6 flex flex-col gap-4 items-center w-full max-w-xs mx-auto">
                <a id="download-button" href="#" download="converted-images.pdf" class="w-full flex items-center justify-center gap-3 px-6 py-3 bg-primary text-white font-bold text-lg rounded-lg shadow-md hover:bg-primary-700 active:bg-primary-800 focus:outline-none focus:ring-4 focus:ring-primary/30 transition-all duration-300">
                   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>
                    Download PDF
                </a>
                 <button id="reset-button-result" class="w-full px-6 py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 focus:outline-none focus:ring-4 focus:ring-slate-300/50 transition-all duration-200">
                    Convert More
                </button>
            </div>
        </div>
    </template>
    
    <template id="multi-pdf-result-template">
        <div class="text-center p-8 bg-green-50 rounded-2xl border-2 border-dashed border-green-300 min-h-[400px] flex flex-col justify-center items-center w-full">
            <h2 class="text-2xl font-bold text-green-800">Conversion Successful!</h2>
            <p class="mt-4 text-slate-600">Your individual PDF files are ready.</p>
            <div class="mt-6 flex flex-col gap-4 items-center w-full max-w-sm mx-auto">
                 <button id="download-zip-button" class="w-full flex items-center justify-center gap-3 px-6 py-3 bg-primary text-white font-bold text-lg rounded-lg shadow-md hover:bg-primary-700 active:bg-primary-800 focus:outline-none focus:ring-4 focus:ring-primary/30 transition-all duration-300 disabled:bg-slate-400 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm0 14V4h12v12H4zm3-4a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    Download All (.zip)
                </button>
                <div class="w-full text-sm text-slate-500">Individual files:</div>
                <div id="pdf-list-container" class="w-full max-h-40 overflow-y-auto custom-scrollbar border rounded-lg bg-white/70 p-2 space-y-2">
                    <!-- individual links will be here -->
                </div>
                 <button id="reset-button-result-multi" class="w-full px-6 py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 focus:outline-none focus:ring-4 focus:ring-slate-300/50 transition-all duration-200">
                    Convert More
                </button>
            </div>
        </div>
    </template>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.jspdf === 'undefined' || typeof window.JSZip === 'undefined') {
                const appContainer = document.getElementById('app-container');
                appContainer.innerHTML = `<div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-r-lg"><p class="font-bold">Initialization Error</p><p>Could not load a required library. Please check your internet connection and refresh the page.</p></div>`;
                return;
            }
            const { jsPDF } = window.jspdf;
            const JSZip = window.JSZip;

            let imageFiles = [];
            let downloadUrls = [];
            let fileIdCounter = 0;

            const App = {
                // Views
                dropzoneView: document.getElementById('dropzone-view'),
                editorView: document.getElementById('editor-view'),
                processingView: document.getElementById('processing-view'),
                resultView: document.getElementById('result-view'),
                errorView: document.getElementById('error-view'),
                
                // Elements
                dropzone: document.getElementById('dropzone'),
                fileInput: document.getElementById('file-input'),
                fileGrid: document.getElementById('file-grid'),
                fileCount: document.getElementById('file-count'),
                fileGridItemTemplate: document.getElementById('file-grid-item-template'),
                singlePdfResultTemplate: document.getElementById('single-pdf-result-template'),
                multiPdfResultTemplate: document.getElementById('multi-pdf-result-template'),
                errorMessageEl: document.getElementById('error-message'),
                
                // Controls
                convertButton: document.getElementById('convert-button'),
                addMoreButton: document.getElementById('add-more-button'),
                clearAllButton: document.getElementById('clear-all-button'),

                // Options
                pageSizeSelect: document.getElementById('page-size'),
                orientationButtons: document.querySelectorAll('.orientation-btn'),
                qualitySlider: document.getElementById('quality-slider'),
                qualityValue: document.getElementById('quality-value'),
                combineToggle: document.getElementById('combine-toggle'),

                // Processing
                progressBar: document.getElementById('progress-bar'),
                processingMessage: document.getElementById('processing-message'),
            };

            const updateView = (view) => {
                App.dropzoneView.classList.toggle('hidden', view !== 'dropzone');
                App.editorView.classList.toggle('hidden', view !== 'editor');
                App.processingView.classList.toggle('hidden', view !== 'processing');
                App.processingView.classList.toggle('flex', view === 'processing');
                App.resultView.classList.toggle('hidden', view !== 'result');
                App.resultView.classList.toggle('flex', view === 'result');
                App.errorView.classList.toggle('hidden', !App.errorMessageEl.textContent);
            };

            const resetState = () => {
                downloadUrls.forEach(url => URL.revokeObjectURL(url));
                downloadUrls = [];
                imageFiles.forEach(f => URL.revokeObjectURL(f.previewUrl));
                imageFiles = [];
                fileIdCounter = 0;
                App.fileInput.value = '';
                App.errorMessageEl.textContent = '';
                App.combineToggle.checked = true;
                renderFileGrid();
                updateView('dropzone');
            };

            const showError = (message, clear = false) => {
                App.errorMessageEl.textContent = message;
                if(clear) setTimeout(() => { App.errorMessageEl.textContent = ''; updateView(imageFiles.length > 0 ? 'editor' : 'dropzone'); }, 3000);
                updateView(imageFiles.length > 0 ? 'editor' : 'dropzone');
            };
            
            const handleFilesSelected = (files) => {
                App.errorMessageEl.textContent = ''; App.errorView.classList.add('hidden');
                const newFiles = Array.from(files).filter(file => {
                    if (!['image/jpeg', 'image/jpg'].includes(file.type)) {
                        showError(`File "${file.name}" is not a JPG and was skipped.`, true);
                        return false;
                    }
                    return !imageFiles.some(f => f.file.name === file.name && f.file.size === file.size);
                });

                if (newFiles.length > 0) {
                    newFiles.forEach(file => {
                        imageFiles.push({
                            id: fileIdCounter++,
                            file: file,
                            previewUrl: URL.createObjectURL(file),
                            rotation: 0,
                            flipH: false,
                            flipV: false,
                            error: null,
                        });
                    });
                    renderFileGrid();
                }
            };
            
            const renderFileGrid = () => {
                App.fileGrid.innerHTML = '';
                if (imageFiles.length === 0) {
                    updateView('dropzone');
                    return;
                }

                imageFiles.forEach(fileData => {
                    const item = App.fileGridItemTemplate.content.cloneNode(true);
                    const container = item.querySelector('.group');
                    const img = item.querySelector('img');
                    const nameEl = item.querySelector('.font-bold');
                    
                    container.dataset.id = fileData.id;
                    img.src = fileData.previewUrl;
                    nameEl.textContent = fileData.file.name;
                    nameEl.title = fileData.file.name;

                    applyTransform(img, fileData);

                    item.querySelector('.remove-btn').onclick = () => removeFile(fileData.id);
                    item.querySelector('.rotate-l-btn').onclick = () => { fileData.rotation = (fileData.rotation - 90 + 360) % 360; applyTransform(img, fileData); };
                    item.querySelector('.rotate-r-btn').onclick = () => { fileData.rotation = (fileData.rotation + 90) % 360; applyTransform(img, fileData); };
                    item.querySelector('.flip-h-btn').onclick = () => { fileData.flipH = !fileData.flipH; applyTransform(img, fileData); };
                    item.querySelector('.flip-v-btn').onclick = () => { fileData.flipV = !fileData.flipV; applyTransform(img, fileData); };

                    App.fileGrid.appendChild(item);
                });
                
                App.fileCount.textContent = imageFiles.length;
                App.convertButton.disabled = imageFiles.length === 0;
                updateView('editor');
            };
            
            const applyTransform = (imgElement, fileData) => {
                const scaleH = fileData.flipH ? -1 : 1;
                const scaleV = fileData.flipV ? -1 : 1;
                imgElement.style.transform = `rotate(${fileData.rotation}deg) scale(${scaleH}, ${scaleV})`;
            };

            const removeFile = (id) => {
                const fileToRemove = imageFiles.find(f => f.id === id);
                if(fileToRemove && fileToRemove.previewUrl) URL.revokeObjectURL(fileToRemove.previewUrl);
                imageFiles = imageFiles.filter(f => f.id !== id);
                renderFileGrid();
            };
            
            const getTransformedImage = async (fileData, quality) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onerror = reject;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const rad = fileData.rotation * Math.PI / 180;
                        const isSideways = fileData.rotation === 90 || fileData.rotation === 270;
                        
                        canvas.width = isSideways ? img.height : img.width;
                        canvas.height = isSideways ? img.width : img.height;
                        
                        ctx.translate(canvas.width / 2, canvas.height / 2);
                        ctx.rotate(rad);
                        ctx.scale(fileData.flipH ? -1 : 1, fileData.flipV ? -1 : 1);
                        ctx.drawImage(img, -img.width / 2, -img.height / 2);
                        
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = fileData.previewUrl;
                });
            };

            const getPdfOptions = () => ({
                orientation: App.orientationButtons[0].classList.contains('bg-primary/10') ? 'p' : 'l',
                unit: 'pt',
                format: App.pageSizeSelect.value,
                putOnlyUsedFonts: true,
                compress: true,
            });

            const addImageToPdf = (doc, imgData) => {
                const props = doc.getImageProperties(imgData);
                const pageW = doc.internal.pageSize.getWidth();
                const pageH = doc.internal.pageSize.getHeight();
                const margin = 40;
                
                const usableW = pageW - margin * 2;
                const usableH = pageH - margin * 2;
                
                let imgW = props.width;
                let imgH = props.height;
                const ratio = imgW / imgH;

                if (imgW > usableW) {
                    imgW = usableW;
                    imgH = imgW / ratio;
                }
                if (imgH > usableH) {
                    imgH = usableH;
                    imgW = imgH * ratio;
                }

                const x = (pageW - imgW) / 2;
                const y = (pageH - imgH) / 2;
                
                doc.addImage(imgData, 'JPEG', x, y, imgW, imgH, undefined, 'FAST');
            };

            const handleConvert = async () => {
                if (imageFiles.length === 0) return;
                updateView('processing');
                App.errorMessageEl.textContent = '';
                App.progressBar.style.width = '0%';
                
                try {
                    const options = getPdfOptions();
                    const quality = parseInt(App.qualitySlider.value, 10) / 100;

                    if (App.combineToggle.checked) {
                        const doc = new jsPDF(options);
                        for (let i = 0; i < imageFiles.length; i++) {
                            const fileData = imageFiles[i];
                            const progress = ((i + 1) / imageFiles.length) * 100;
                            App.processingMessage.textContent = `Processing image ${i + 1} of ${imageFiles.length}: ${fileData.file.name}`;
                            App.progressBar.style.width = `${progress}%`;

                            if (i > 0) doc.addPage();
                            const imgData = await getTransformedImage(fileData, quality);
                            addImageToPdf(doc, imgData);
                        }
                        
                        App.processingMessage.textContent = 'Finalizing PDF...';
                        const blob = doc.output('blob');
                        const url = URL.createObjectURL(blob);
                        downloadUrls.push(url);
                        displaySingleResult(url);

                    } else {
                        const generatedPdfs = [];
                        for (let i = 0; i < imageFiles.length; i++) {
                            const fileData = imageFiles[i];
                            const progress = ((i + 1) / imageFiles.length) * 100;
                            App.processingMessage.textContent = `Creating PDF ${i + 1} of ${imageFiles.length}: ${fileData.file.name}`;
                            App.progressBar.style.width = `${progress}%`;
                            
                            const doc = new jsPDF(options);
                            const imgData = await getTransformedImage(fileData, quality);
                            addImageToPdf(doc, imgData);
                            const blob = doc.output('blob');
                            const fileName = fileData.file.name.replace(/\.[^/.]+$/, "") + ".pdf";
                            generatedPdfs.push({ fileName, blob });
                        }
                        App.processingMessage.textContent = 'Finalizing...';
                        displayMultiResult(generatedPdfs);
                    }
                } catch (e) {
                    console.error(e);
                    showError(`Conversion failed. An unexpected error occurred: ${e.message}`);
                    updateView('editor');
                }
            };

            const displaySingleResult = (url) => {
                App.resultView.innerHTML = '';
                const resultNode = App.singlePdfResultTemplate.content.cloneNode(true);
                resultNode.querySelector('#download-button').href = url;
                resultNode.querySelector('#reset-button-result').onclick = resetState;
                App.resultView.appendChild(resultNode);
                updateView('result');
            };

            const displayMultiResult = (pdfs) => {
                App.resultView.innerHTML = '';
                const resultNode = App.multiPdfResultTemplate.content.cloneNode(true);
                const pdfListContainer = resultNode.querySelector('#pdf-list-container');

                pdfs.forEach(({ fileName, blob }) => {
                    const url = URL.createObjectURL(blob);
                    downloadUrls.push(url);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    link.className = "flex justify-between items-center p-2 bg-slate-50 hover:bg-slate-100 rounded-md text-sm transition-colors";
                    link.innerHTML = `
                        <span class="font-medium text-slate-700 truncate pr-2">${fileName}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary shrink-0" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>
                    `;
                    pdfListContainer.appendChild(link);
                });

                resultNode.querySelector('#download-zip-button').onclick = async (e) => {
                    const btn = e.currentTarget;
                    const originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Zipping...`;
                    
                    const zip = new JSZip();
                    pdfs.forEach(({ fileName, blob }) => zip.file(fileName, blob));
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    const zipUrl = URL.createObjectURL(zipBlob);
                    downloadUrls.push(zipUrl);

                    const zipLink = document.createElement('a');
                    zipLink.href = zipUrl;
                    zipLink.download = 'converted-pdfs.zip';
                    document.body.appendChild(zipLink);
                    zipLink.click();
                    document.body.removeChild(zipLink);
                    
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                };

                resultNode.querySelector('#reset-button-result-multi').onclick = resetState;
                App.resultView.appendChild(resultNode);
                updateView('result');
            };


            // Event Listeners Setup
            App.dropzone.addEventListener('click', () => App.fileInput.click());
            App.fileInput.addEventListener('change', (e) => handleFilesSelected(e.target.files));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                App.dropzone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                App.dropzone.addEventListener(eventName, () => App.dropzone.classList.add('border-primary', 'bg-primary/10'));
            });
            ['dragleave', 'drop'].forEach(eventName => {
                App.dropzone.addEventListener(eventName, () => App.dropzone.classList.remove('border-primary', 'bg-primary/10'));
            });
            App.dropzone.addEventListener('drop', e => handleFilesSelected(e.dataTransfer.files));
            
            App.convertButton.addEventListener('click', handleConvert);
            App.addMoreButton.addEventListener('click', () => App.fileInput.click());
            App.clearAllButton.addEventListener('click', resetState);

            App.orientationButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    App.orientationButtons.forEach(b => {
                        b.classList.remove('bg-primary/10', 'border-primary', 'text-primary');
                        b.classList.add('border-slate-300', 'text-slate-600', 'hover:bg-slate-100');
                    });
                    btn.classList.add('bg-primary/10', 'border-primary', 'text-primary');
                    btn.classList.remove('border-slate-300', 'text-slate-600', 'hover:bg-slate-100');
                });
            });

            App.qualitySlider.addEventListener('input', (e) => {
                App.qualityValue.textContent = e.target.value;
            });

            // Initial state
            updateView('dropzone');
        });
    </script>
</body>
</html>