name: Auto-generate image sitemap

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Critical: This gives the action permission to push changes back to your repo
permissions:
  contents: write

jobs:
  generate-image-sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate image-sitemap.xml
        # We use a simple node script. Added a check to ensure 'images' dir exists.
        run: |
          node <<'EOF'
          const fs = require('fs');
          const path = require('path');

          const SITE_URL = 'https://simpliconvert.com';
          const IMAGES_DIR = 'images';
          const OUTPUT = 'image-sitemap.xml';

          // Ensure directory exists to avoid crash
          if (!fs.existsSync(IMAGES_DIR)) {
            console.log(`Directory "${IMAGES_DIR}" not found. Creating empty sitemap.`);
            fs.writeFileSync(OUTPUT, '');
            process.exit(0);
          }

          function walk(dir) {
            let results = [];
            const list = fs.readdirSync(dir);
            list.forEach(file => {
              const fullPath = path.join(dir, file);
              const stat = fs.statSync(fullPath);
              if (stat.isDirectory()) {
                results = results.concat(walk(fullPath));
              } else if (/\.(png|jpe?g|gif|webp|svg)$/i.test(file)) {
                results.push(fullPath);
              }
            });
            return results;
          }

          const images = walk(IMAGES_DIR);

          // Group all images under the homepage LOC to avoid duplicate URL entries
          let xml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
          xml += `<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"\n`;
          xml += `        xmlns:image="http://www.google.com/schemas/sitemap-image/1.1">\n`;

          if (images.length > 0) {
            xml += `  <url>\n`;
            xml += `    <loc>${SITE_URL}/</loc>\n`;
            
            images.forEach(img => {
              // Ensure forward slashes for URLs even on different OS
              const relativePath = img.split(path.sep).join('/');
              const imgUrl = `${SITE_URL}/${relativePath}`;
              xml += `    <image:image>\n`;
              xml += `      <image:loc>${imgUrl}</image:loc>\n`;
              xml += `    </image:image>\n`;
            });
            
            xml += `  </url>\n`;
          }

          xml += `</urlset>`;

          fs.writeFileSync(OUTPUT, xml.trim());
          console.log(`Generated ${OUTPUT} with ${images.length} images`);
          EOF

      - name: Commit image sitemap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add image-sitemap.xml
          # Only commit if there are changes to avoid empty commit errors
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-generate image sitemap"
            git push
          fi
