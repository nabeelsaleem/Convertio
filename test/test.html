
    


<!-- Babel for JSX transpilation -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react-dropzone": "https://esm.sh/react-dropzone@14.2.3?deps=react@18.2.0",
    "@hello-pangea/dnd": "https://esm.sh/@hello-pangea/dnd@16.5.0?deps=react@18.2.0"
  }
}
</script>

<div id="root"></div>
<script>
  // Configure the worker for pdf.js. This is required for it to work correctly.
  if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.worker.min.js';
  }
</script>
<script type="text/babel" data-type="module">
  import React, { useState, useCallback } from 'react';
  import ReactDOM from 'react-dom/client';
  import { useDropzone } from 'react-dropzone';
  import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';

  // --- Helper Functions (from pdfService.ts) ---
  const { pdfjsLib } = window;
  const { PDFDocument, degrees } = window.PDFLib;

  const generateThumbnail = async (file) => {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const page = await pdf.getPage(1);

    const viewport = page.getViewport({ scale: 0.5 });
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    
    if (!context) {
      throw new Error('Could not get canvas context');
    }

    canvas.height = viewport.height;
    canvas.width = viewport.width;

    await page.render({ canvasContext: context, viewport: viewport }).promise;

    return canvas.toDataURL('image/jpeg');
  };

  const mergePdfs = async (files) => {
    const mergedPdf = await PDFDocument.create();

    for (const file of files) {
      const arrayBuffer = await file.file.arrayBuffer();
      const pdfToCopy = await PDFDocument.load(arrayBuffer, { 
        ignoreEncryption: true 
      });

      const pages = await mergedPdf.copyPages(pdfToCopy, pdfToCopy.getPageIndices());
      
      pages.forEach(page => {
        if (file.rotation !== 0) {
          page.setRotation(degrees(file.rotation));
        }
        mergedPdf.addPage(page);
      });
    }

    return await mergedPdf.save();
  };

  // --- Icon Components ---
  const UploadIcon = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
    </svg>
  );
  const TrashIcon = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
    </svg>
  );
  const RotateLeftIcon = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M15 15l-6 6m0 0l-6-6m6 6V9a6 6 0 0112 0v3" />
    </svg>
  );
  const RotateRightIcon = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M9 15l6 6m0 0l6-6m-6 6V9a6 6 0 00-12 0v3" />
    </svg>
  );
  const SuccessIcon = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
        <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
  );

  // --- UI Components ---
  const Spinner = ({ className }) => (
    <svg className={`animate-spin h-5 w-5 text-current ${className}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
  );

  const Dropzone = ({ getRootProps, getInputProps, isDragActive }) => (
    <div
      {...getRootProps()}
      className={`w-full p-10 md:p-16 border-4 border-dashed rounded-xl cursor-pointer transition-all duration-300 text-center flex flex-col items-center justify-center
        ${isDragActive ? 'border-[#da3f0b] bg-orange-50' : 'border-gray-300 bg-gray-50 hover:border-gray-400'}`}
    >
      <input {...getInputProps()} />
      <UploadIcon className="w-16 h-16 text-gray-400 mb-4" />
      <p className="text-xl font-semibold text-gray-700">
        {isDragActive ? 'Drop the files here...' : 'Drag & drop PDFs here'}
      </p>
      <p className="text-gray-500 mt-2">or click to select files</p>
    </div>
  );

  const PdfThumbnail = ({ file, onRemove, onRotate }) => (
    <div className="group relative flex flex-col bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden h-full">
        <div className="p-2 bg-gray-100 flex-shrink-0">
            <img
                src={file.thumbnailUrl}
                alt={`Preview of ${file.file.name}`}
                className="w-full h-40 object-contain transition-transform duration-300"
                style={{ transform: `rotate(${file.rotation}deg)` }}
            />
        </div>
        <div className="p-3 flex-grow flex flex-col justify-between">
            <p className="text-xs text-gray-600 font-medium break-all" title={file.file.name}>
                {file.file.name}
            </p>
            <div className="flex justify-center items-center mt-3 space-x-2">
                <button onClick={() => onRotate(file.id, 'left')} className="p-1.5 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 hover:text-gray-800 transition-colors" title="Rotate Left">
                    <RotateLeftIcon className="w-4 h-4" />
                </button>
                <button onClick={() => onRemove(file.id)} className="p-1.5 rounded-full bg-red-100 text-red-600 hover:bg-red-200 hover:text-red-800 transition-colors" title="Remove">
                    <TrashIcon className="w-4 h-4" />
                </button>
                <button onClick={() => onRotate(file.id, 'right')} className="p-1.5 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 hover:text-gray-800 transition-colors" title="Rotate Right">
                    <RotateRightIcon className="w-4 h-4" />
                </button>
            </div>
        </div>
    </div>
  );

  const SuccessView = ({ mergedPdf, onReset }) => (
      <div className="text-center p-8 border border-green-200 bg-green-50 rounded-lg">
          <SuccessIcon className="w-16 h-16 text-green-500 mx-auto mb-4" />
          <h2 className="text-2xl font-bold text-gray-800">Merge Successful!</h2>
          <p className="text-gray-600 mt-2 mb-6">Your new PDF is ready for download.</p>
          <div className="flex flex-col sm:flex-row justify-center gap-4">
              <a
                  href={mergedPdf.url}
                  download={mergedPdf.name}
                  className="w-full sm:w-auto flex items-center justify-center px-8 py-3 bg-[#da3f0b] text-white font-bold rounded-lg shadow-md hover:bg-[#c3370a] transition-all duration-300 transform hover:scale-105"
              >
                  Download PDF
              </a>
              <button
                  onClick={onReset}
                  className="w-full sm:w-auto text-center px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition-colors"
              >
                  Merge More PDFs
              </button>
          </div>
      </div>
  );

  // --- Main App Component ---
  const App = () => {
    const [pdfFiles, setPdfFiles] = useState([]);
    const [isProcessing, setIsProcessing] = useState(false);
    const [error, setError] = useState(null);
    const [mergedPdf, setMergedPdf] = useState(null);

    const handleFileDrop = useCallback(async (acceptedFiles) => {
      setError(null);
      const pdfs = acceptedFiles.filter(file => file.type === 'application/pdf');
      if (pdfs.length !== acceptedFiles.length) {
        setError('Some files were not PDFs and were ignored.');
      }
      if (pdfs.length === 0) {
        if (acceptedFiles.length > 0) {
          setError('Please upload files in PDF format only.');
        }
        return;
      }

      setIsProcessing(true);
      try {
        const newFiles = await Promise.all(
          pdfs.map(async (file) => {
            const thumbnailUrl = await generateThumbnail(file);
            return {
              id: `${file.name}-${Date.now()}-${Math.random()}`,
              file,
              thumbnailUrl,
              rotation: 0,
            };
          })
        );
        setPdfFiles(currentFiles => [...currentFiles, ...newFiles]);
      } catch (err) {
        console.error(err);
        setError('Could not process one or more PDF files. They may be corrupt or protected.');
      } finally {
        setIsProcessing(false);
      }
    }, []);
    
    const { getRootProps, getInputProps, isDragActive } = useDropzone({
      onDrop: handleFileDrop,
      accept: { 'application/pdf': ['.pdf'] },
    });

    const handleRemoveFile = (id) => {
      setPdfFiles(currentFiles => currentFiles.filter(f => f.id !== id));
    };

    const handleRotateFile = (id, direction) => {
      const angle = direction === 'right' ? 90 : -90;
      setPdfFiles(currentFiles => 
        currentFiles.map(f => 
          f.id === id ? { ...f, rotation: (f.rotation + angle + 360) % 360 } : f
        )
      );
    };
    
    const handleMerge = async () => {
      if (pdfFiles.length < 2) {
        setError("Please upload at least two PDF files to merge.");
        return;
      }
      setError(null);
      setIsProcessing(true);
      try {
        const mergedPdfBytes = await mergePdfs(pdfFiles);
        const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        setMergedPdf({ url, name: `merged-${Date.now()}.pdf` });
      } catch (err) {
        console.error(err);
        setError("An error occurred while merging the PDFs. Please try again.");
      } finally {
        setIsProcessing(false);
      }
    };

    const handleDragEnd = (result) => {
      const { source, destination } = result;
      if (!destination) return;
      const items = Array.from(pdfFiles);
      const [reorderedItem] = items.splice(source.index, 1);
      items.splice(destination.index, 0, reorderedItem);
      setPdfFiles(items);
    };
    
    const handleReset = () => {
        if (mergedPdf && mergedPdf.url) {
            URL.revokeObjectURL(mergedPdf.url);
        }
        setPdfFiles([]);
        setError(null);
        setMergedPdf(null);
        setIsProcessing(false);
    };

    return (
      <div className="min-h-screen flex justify-center p-4 bg-gray-50">

        <main className="w-full max-w-4xl mx-auto">
          <div className="bg-white rounded-2xl shadow-xl p-6 md:p-10 border border-gray-200">
            
            
            {error && (
              <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md" role="alert">
                <p>{error}</p>
              </div>
            )}
            
            {mergedPdf ? (
                <SuccessView mergedPdf={mergedPdf} onReset={handleReset} />
            ) : pdfFiles.length === 0 ? (
              <Dropzone
                getRootProps={getRootProps}
                getInputProps={getInputProps}
                isDragActive={isDragActive}
              />
            ) : (
               <div className="relative">
                  {isProcessing && (
                    <div className="absolute inset-0 bg-white bg-opacity-75 flex flex-col items-center justify-center z-30 rounded-lg">
                      <Spinner />
                      <p className="mt-4 text-gray-600 font-medium">Processing...</p>
                    </div>
                  )}
                  <DragDropContext onDragEnd={handleDragEnd}>
                    <Droppable droppableId="pdf-thumbnails" direction="horizontal">
                      {(provided) => (
                        <div 
                          ref={provided.innerRef} 
                          {...provided.droppableProps}
                          className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 md:gap-6 mb-8 min-h-[200px]"
                        >
                          {pdfFiles.map((file, index) => (
                            <Draggable key={file.id} draggableId={file.id} index={index}>
                              {(provided, snapshot) => (
                                <div
                                  ref={provided.innerRef}
                                  {...provided.draggableProps}
                                  {...provided.dragHandleProps}
                                  style={{...provided.draggableProps.style}}
                                  className={`transform transition-transform ${snapshot.isDragging ? 'scale-105 z-20 shadow-2xl' : 'scale-100 z-10 shadow-none'}`}
                                >
                                  <PdfThumbnail 
                                    file={file}
                                    onRemove={() => handleRemoveFile(file.id)}
                                    onRotate={handleRotateFile}
                                  />
                                </div>
                              )}
                            </Draggable>
                          ))}
                          {provided.placeholder}
                        </div>
                      )}
                    </Droppable>
                  </DragDropContext>
                  
                  <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                      <button 
                          onClick={() => document.getElementById('file-upload-secondary')?.click()}
                          className="w-full sm:w-auto text-center px-6 py-3 border-2 border-dashed border-gray-300 text-gray-600 font-semibold rounded-lg hover:bg-gray-100 hover:border-gray-400 transition-colors"
                      >
                          Add More Files
                      </button>
                      <input {...getInputProps()} id="file-upload-secondary" className="hidden" />
                      
                      <button
                          onClick={handleMerge}
                          disabled={isProcessing || pdfFiles.length < 2}
                          className="w-full sm:w-auto flex items-center justify-center px-8 py-3 bg-[#da3f0b] text-white font-bold rounded-lg shadow-md hover:bg-[#c3370a] disabled:bg-gray-400 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105"
                      >
                          {isProcessing ? <Spinner /> : `Merge ${pdfFiles.length} PDFs`}
                      </button>
                  </div>
               </div>
            )}
          </div>
        </main>
      </div>
    );
  };

  // --- App Entry Point ---
  const rootElement = document.getElementById('root');
  if (!rootElement) {
    throw new Error("Could not find root element to mount to");
  }
  const root = ReactDOM.createRoot(rootElement);
  root.render(
    <React.StrictMode>
      <App />
    </React.StrictMode>
  );
</script>
